# ç¬¬ 1 ç« ï½œASP.NET Core 5 æ¶æ§‹æ·±å…¥å‰–æ

---

## 1.1 å°ˆæ¡ˆçµæ§‹èˆ‡å•Ÿå‹•æµç¨‹

ğŸ§­ ç›®æ¨™ï¼šçœ‹æ‡‚ä¸€å€‹ ASP.NET Core 5 å°ˆæ¡ˆå¾ã€Œå•Ÿå‹• â†’ å»ºæ§‹ä¸»æ©Ÿ â†’ å»ºç®¡ç·š â†’ æ¥è«‹æ±‚ã€çš„æ•´å€‹æ—…ç¨‹ã€‚

### æ¨™æº–å°ˆæ¡ˆéª¨æ¶

```
MyApi/
â”œâ”€ Controllers/
â”œâ”€ Models/
â”œâ”€ Services/
â”œâ”€ Program.cs
â”œâ”€ Startup.cs
â”œâ”€ appsettings.json
â”œâ”€ appsettings.Development.json
â””â”€ MyApi.csproj
```

### å•Ÿå‹•é †åºï¼ˆ.NET 5 æ¨™æº–æ¨£å¼ï¼‰

1. **Program.cs**ï¼šå»ºç«‹ Generic Hostï¼ˆé€šç”¨ä¸»æ©Ÿï¼‰â†’ `CreateHostBuilder(args).Build().Run()`
2. **Startup.cs**ï¼š

   * `ConfigureServices`ï¼šè¨»å†Šæœå‹™åˆ° DI å®¹å™¨
   * `Configure`ï¼šå»ºç½® **Request Pipelineï¼ˆä¸­ä»‹è»Ÿé«”é †åºï¼‰**
3. **Host** å•Ÿå‹• Kestrel â†’ ç›£è½é€£ç·š â†’ äº¤çµ¦ç®¡ç·šè™•ç†è«‹æ±‚

> å‚™è¨»ï¼šä½ å¯èƒ½æœƒçœ‹åˆ°ç¶²è·¯ä¸Šæœ‰ `WebApplication` çš„ç¯„ä¾‹ï¼Œé‚£æ˜¯ .NET 6+ çš„ã€Œæœ€å°åŒ–ä¸»æ©Ÿæ¨¡å‹ã€ã€‚æœ¬æ•™æä»¥ .NET 5 çš„ `Host + Startup` ç‚ºä¸»ï¼Œå¶çˆ¾æœƒè£œå……å°ç…§è§€å¿µã€‚

### ç¯„ä¾‹ï¼šæœ€å°å¯é‹ä½œçš„ Program + Startup

**Program.cs**

```csharp
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Hosting;

public class Program
{
    public static void Main(string[] args)
        => CreateHostBuilder(args).Build().Run();

    public static IHostBuilder CreateHostBuilder(string[] args) =>
        Host.CreateDefaultBuilder(args) // è¼‰å…¥ç’°å¢ƒè®Šæ•¸ã€appsettings*.jsonã€User Secretsï¼ˆDevï¼‰ç­‰
            .ConfigureWebHostDefaults(webBuilder =>
            {
                webBuilder.UseStartup<Startup>(); // å°åˆ° Startup
            });
}
```

**Startup.cs**

```csharp
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;

public class Startup
{
    public Startup(IConfiguration config, IWebHostEnvironment env)
    {
        Configuration = config;
        Environment = env;
    }

    public IConfiguration Configuration { get; }
    public IWebHostEnvironment Environment { get; }

    // 1) è¨»å†Šæœå‹™
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddControllers();
        // å…¶ä»–ï¼šDIã€DbContextã€Options ç¶å®šã€Swaggerã€CORSã€Auth ç­‰ç­‰
    }

    // 2) å»ºç½®ä¸­ä»‹è»Ÿé«”ç®¡ç·šï¼ˆé †åº**å¾ˆé‡è¦**ï¼‰
    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        if (env.IsDevelopment()) app.UseDeveloperExceptionPage();

        app.UseHttpsRedirection();

        app.UseRouting();

        app.UseAuthentication(); // è‹¥æœ‰é©—è­‰ï¼Œå¿…é ˆåœ¨ Authorization ä¹‹å‰
        app.UseAuthorization();

        app.UseEndpoints(endpoints =>
        {
            endpoints.MapControllers();
        });
    }
}
```

---

## 1.2 ä¾è³´åè½‰ï¼ˆDIï¼‰å®¹å™¨

ğŸ§© ç›®æ¨™ï¼šæ­£ç¢ºæŒ‘é¸ Service Lifetimeã€æœƒå¤šä»‹é¢è¨»å†Šã€æŒæ¡å·¥å» /å‘½åé¢¨æ ¼ã€‚

### æœå‹™ç”Ÿå‘½é€±æœŸï¼ˆService Lifetimeï¼‰

* **Transient**ï¼šæ¯æ¬¡è§£æéƒ½ç”¢ç”Ÿæ–°ç‰©ä»¶ï¼Œé©åˆç„¡ç‹€æ…‹ã€è¼•é‡å‹æœå‹™ã€‚
* **Scoped**ï¼šåŒä¸€æ¬¡ HTTP è«‹æ±‚ï¼ˆScopeï¼‰å…§å…±äº«åŒä¸€å¯¦ä¾‹ã€‚**Web API æœ€å¸¸ç”¨**ã€‚
* **Singleton**ï¼šæ‡‰ç”¨ç¨‹å¼å­˜æ´»æœŸé–“åªæœ‰ä¸€ä»½ï¼Œé©åˆæ˜‚è²´/åŸ·è¡Œç·’å®‰å…¨çš„æœå‹™ã€‚

**ç¤ºç¯„ï¼šè¨»å†Šèˆ‡è§£æ**

```csharp
public interface IClock { DateTime Now(); }
public class SystemClock : IClock { public DateTime Now() => DateTime.UtcNow; }

public void ConfigureServices(IServiceCollection services)
{
    services.AddTransient<IClock, SystemClock>();
    services.AddScoped<IMailSender, SmtpMailSender>();
    services.AddSingleton<IAppCache, MemoryAppCache>();
}
```

**å¤šä»‹é¢è¨»å†Šï¼ˆåŒä¸€å¯¦ä½œå°æ‡‰å¤šä»‹é¢ï¼‰**

```csharp
public interface IReadRepo {}
public interface IWriteRepo {}
public class EfOrderRepository : IReadRepo, IWriteRepo {}

services.AddScoped<IReadRepo, EfOrderRepository>();
services.AddScoped<IWriteRepo, EfOrderRepository>();
```

**ä»¥å·¥å» å»ºç«‹ï¼ˆå–æ±ºæ–¼çµ„æ…‹æˆ–ç’°å¢ƒï¼‰**

```csharp
services.AddSingleton<IStorage>(sp =>
{
    var cfg = sp.GetRequiredService<IConfiguration>();
    var useLocal = cfg.GetValue<bool>("Storage:UseLocal");
    return useLocal ? new LocalStorage() : new S3Storage(cfg["Storage:S3:Bucket"]);
});
```

**å…·åï¼ˆå‘½åï¼‰è¨»å†Šçš„å¸¸è¦‹æ‰‹æ³•**

> ASP.NET Core DI æ²’æœ‰å…§å»ºã€Œå‘½åæœå‹™ã€ï¼Œå¯é€é **Factory + Key** æˆ– **å­—å…¸** æ¨¡å¼é”æˆã€‚

```csharp
public interface IPayGateway { Task PayAsync(); }
public class Ecpay : IPayGateway { /*...*/ public Task PayAsync()=>Task.CompletedTask; }
public class NewebPay : IPayGateway { /*...*/ public Task PayAsync()=>Task.CompletedTask; }

services.AddSingleton<Ecpay>();
services.AddSingleton<NewebPay>();
services.AddSingleton<Func<string, IPayGateway>>(sp => key => key switch
{
    "ecpay"   => sp.GetRequiredService<Ecpay>(),
    "neweb"   => sp.GetRequiredService<NewebPay>(),
    _         => throw new ArgumentOutOfRangeException(nameof(key))
});
```

**åœ¨ Controller ä½¿ç”¨**

```csharp
[ApiController, Route("api/pay")]
public class PayController : ControllerBase
{
    private readonly Func<string, IPayGateway> _factory;
    public PayController(Func<string, IPayGateway> factory) => _factory = factory;

    [HttpPost("{channel}")]
    public async Task<IActionResult> Pay(string channel)
    {
        var gateway = _factory(channel);
        await gateway.PayAsync();
        return Ok(new { channel, ok = true });
    }
}
```

---

## 1.3 çµ„æ…‹ï¼ˆConfigurationï¼‰

ğŸ§° ç›®æ¨™ï¼šæœƒè®€å¤šä¾†æºçµ„æ…‹ã€åšå¼·å‹åˆ¥ç¶å®šã€æ”¯æ´ç†±æ›´æ–°ï¼ˆreload on changeï¼‰ï¼Œä¸¦æ­£ç¢ºåˆ†ç’°å¢ƒã€‚

### å¤šä¾†æºï¼šJSONã€ç’°å¢ƒè®Šæ•¸ã€User Secretsã€å‘½ä»¤åˆ—

`Host.CreateDefaultBuilder` æœƒè‡ªå‹•è¼‰å…¥ï¼š

* `appsettings.json` â†’ `appsettings.{Environment}.json`ï¼ˆè¦†è“‹ï¼‰
* **ç’°å¢ƒè®Šæ•¸**ï¼ˆ`ASPNETCORE_ENVIRONMENT`ã€è‡ªè¨‚éµï¼‰
* **User Secrets**ï¼ˆåƒ…é–‹ç™¼ç’°å¢ƒï¼‰
* **å‘½ä»¤åˆ—**ï¼ˆå†æ¬¡è¦†è“‹ï¼‰

**appsettings.json**

```json
{
  "Smtp": {
    "Host": "smtp.example.com",
    "Port": 587,
    "User": "noreply@example.com"
  },
  "FeatureFlags": {
    "NewCheckout": true
  }
}
```

**å¼·å‹åˆ¥ç¶å®š + Options**

```csharp
public class SmtpOptions
{
    public string Host { get; set; } = default!;
    public int Port { get; set; }
    public string User { get; set; } = default!;
}

public void ConfigureServices(IServiceCollection services)
{
    services.Configure<SmtpOptions>(Configuration.GetSection("Smtp"));
    services.AddSingleton(sp => sp.GetRequiredService<IOptionsMonitor<SmtpOptions>>().CurrentValue);
    services.AddControllers();
}
```

**åœ¨æœå‹™æˆ–æ§åˆ¶å™¨å–ç”¨**

```csharp
public class MailService
{
    private readonly SmtpOptions _opt;
    public MailService(SmtpOptions opt) => _opt = opt;

    public string Describe() => $"{_opt.Host}:{_opt.Port} as {_opt.User}";
}
```

**Reload On Changeï¼ˆç†±æ›´æ–°ï¼‰**
åªè¦ `appsettings.json` æœ‰ `reloadOnChange: true`ï¼ˆé è¨­ CreateDefaultBuilder å·²å•Ÿç”¨ï¼‰ï¼Œä¿®æ”¹æª”æ¡ˆå³å¯è§¸ç™¼ `IOptionsMonitor<T>` å€¼æ›´æ–°ã€‚

**åˆ†ç’°å¢ƒè¨­å®š**

* è¨­å®š `ASPNETCORE_ENVIRONMENT=Development/Staging/Production`
* å»ºç«‹ `appsettings.Development.json` è¦†è“‹å·®ç•°
* åœ¨ `Startup.Configure` ç”¨ `env.IsDevelopment()` åˆ‡æ›è¡Œç‚ºï¼ˆå¦‚é¡¯ç¤ºè©³ç´°éŒ¯èª¤é ï¼‰

---

## 1.4 è¦æ±‚è™•ç†ç®¡ç·šï¼ˆRequest Pipelineï¼‰

ğŸ›¤ï¸ ç›®æ¨™ï¼šç†è§£ä¸­ä»‹è»Ÿé«”é †åºå°è¡Œç‚ºçš„æ±ºå®šæ€§å½±éŸ¿ï¼Œæœƒæ­£ç¢ºåœ° **Use / Map / Run**ï¼Œä¸¦ç©è½‰åˆ†æ”¯èˆ‡çŸ­è·¯ã€‚

### Use / Run / Map çš„å·®ç•°

* `app.Use(...)`ï¼š**å¯å¾€ä¸‹å‚³é**ï¼Œä½ å¯ä»¥åœ¨å‘¼å« `next()` å‰å¾Œå¤¾æ“Šè«‹æ±‚èˆ‡å›æ‡‰ã€‚
* `app.Run(...)`ï¼š**çµ‚æ­¢é»**ï¼Œä¸å†å‘¼å«ä¸‹ä¸€å€‹ä¸­ä»‹è»Ÿé«”ï¼ˆçŸ­è·¯ï¼‰ã€‚
* `app.Map(path, branchApp => { ... })`ï¼šç•¶è·¯å¾‘ç¬¦åˆæ™‚ï¼Œ**åˆ†æ”¯ç®¡ç·š**ã€‚

**æœ€å°ç¤ºç¯„ï¼šé †åºèˆ‡çŸ­è·¯**

```csharp
app.Use(async (ctx, next) =>
{
    Console.WriteLine("A: before");
    await next();
    Console.WriteLine("A: after");
});

app.Use(async (ctx, next) =>
{
    Console.WriteLine("B: before");
    // ä¸å‘¼å« next() å°±åœ¨é€™è£¡çŸ­è·¯
    if (ctx.Request.Path.StartsWithSegments("/stop"))
    {
        await ctx.Response.WriteAsync("Stopped by B");
        return;
    }
    await next();
    Console.WriteLine("B: after");
});

app.Run(async ctx =>
{
    Console.WriteLine("C: terminal");
    await ctx.Response.WriteAsync("Hello from C");
});
```

* `/stop` æœƒåœ¨ B åœä¸‹ï¼Œ**ä¸æœƒ**åˆ° Cã€‚
* å…¶ä»–è·¯å¾‘ï¼šA(before) â†’ B(before) â†’ C â†’ B(after) â†’ A(after)

**Map èˆ‡ MapWhenï¼šåˆ†æ”¯ç®¡ç·š**

```csharp
// /api é–‹ä¸€æ¢æ”¯ç·š
app.Map("/api", branch =>
{
    branch.Run(async ctx => await ctx.Response.WriteAsync("API branch"));
});

// ä¾æ¢ä»¶åˆ†æ”¯ï¼ˆä¾‹å¦‚ï¼šå«ç‰¹å®šæ¨™é ­ï¼‰
app.MapWhen(ctx => ctx.Request.Headers.ContainsKey("X-Debug"), branch =>
{
    branch.Use(async (ctx, next) =>
    {
        ctx.Response.Headers["X-Branch"] = "debug";
        await next();
    });
    branch.Run(async ctx => await ctx.Response.WriteAsync("Debug branch"));
});
```

### å¸¸è¦‹ç®¡ç·šç‰‡æ®µï¼ˆå»ºè­°é †åºï¼‰

1. ä¾‹å¤–è™•ç†ï¼ˆ`UseDeveloperExceptionPage`/å…¨åŸŸéŒ¯èª¤è™•ç†ï¼‰
2. HTTPS è½‰å‘ã€HSTS
3. éœæ…‹æª”æ¡ˆï¼ˆå¦‚éœ€ï¼‰
4. è·¯ç”±ï¼ˆ`UseRouting`ï¼‰
5. CORS
6. é©—è­‰ï¼ˆ`UseAuthentication`ï¼‰
7. æˆæ¬Šï¼ˆ`UseAuthorization`ï¼‰
8. å¿«å–/å£“ç¸®ï¼ˆå¦‚éœ€ï¼‰
9. ç«¯é»ï¼ˆ`UseEndpoints` / MapControllersï¼‰

---

## 1.5 å¯¦ä½œæ¼”ç·´ï¼šå¾é›¶å»ºç½®å¯é©—è­‰çš„ç®¡ç·š

ğŸ§ª ç›®æ¨™ï¼šå»ºç«‹ä¸€å€‹èƒ½çœ‹è¦‹ã€Œé †åºèˆ‡çŸ­è·¯ã€æ•ˆæœçš„å¯åŸ·è¡Œç¯„ä¾‹ã€‚

**Startup.Configureï¼ˆç¯€éŒ„ï¼‰**

```csharp
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    if (env.IsDevelopment()) app.UseDeveloperExceptionPage();

    // 1) å…¨åŸŸæ—¥èªŒä¸­ä»‹è»Ÿé«”ï¼ˆè§€å¯Ÿé †åºï¼‰
    app.Use(async (ctx, next) =>
    {
        var sw = Stopwatch.StartNew();
        await next();
        sw.Stop();
        Console.WriteLine($"{ctx.Request.Method} {ctx.Request.Path} - {sw.ElapsedMilliseconds}ms");
    });

    app.UseRouting();

    // 2) ç°¡æ˜“ API åˆ†æ”¯
    app.Map("/api", api =>
    {
        api.Use(async (ctx, next) =>
        {
            ctx.Response.Headers["X-Powered-By"] = "AspNetCore5";
            await next();
        });

        api.Run(async ctx =>
        {
            await ctx.Response.WriteAsync("Hello API");
        });
    });

    // 3) ä¸€æ¢æœƒçŸ­è·¯çš„æ”¯ç·š
    app.Map("/health", branch =>
    {
        branch.Run(async ctx => await ctx.Response.WriteAsync("OK"));
    });

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapControllers();
    });
}
```

**æ¸¬è©¦çµæœ**

* `GET /health` â†’ ç›´æ¥å›ã€ŒOKã€ï¼Œä¸”ä¸æœƒé€²å…¥ Controllersã€‚
* `GET /api` â†’ æœƒåŠ ä¸Š `X-Powered-By: AspNetCore5`ï¼Œå…§å®¹ã€ŒHello APIã€ã€‚
* å…¶ä»–è·¯å¾‘ â†’ è½åˆ° MVC æ§åˆ¶å™¨æˆ– 404ã€‚

---

## 1.6 å¯¦ä½œæ¼”ç·´ï¼šDI + Options + Controller ä¸²åœ¨ä¸€èµ·

ğŸ§ª ç›®æ¨™ï¼šæŠŠæœ¬ç« é‡é»å…¨éƒ¨ä¸²è¯é©—è­‰ã€‚

**appsettings.Development.json**

```json
{
  "Greeting": { "Message": "Hello, Dev!", "From": "Trainer" }
}
```

**Options é¡åˆ¥èˆ‡æœå‹™**

```csharp
public class GreetingOptions
{
    public string Message { get; set; } = "Hello";
    public string From { get; set; } = "System";
}

public interface IGreetingService
{
    string Greet(string name);
}

public class GreetingService : IGreetingService
{
    private readonly IOptionsMonitor<GreetingOptions> _opt;
    private readonly IClock _clock; // ä¾†è‡ªå‰é¢å°ç¯€çš„ IClock

    public GreetingService(IOptionsMonitor<GreetingOptions> opt, IClock clock)
    {
        _opt = opt;
        _clock = clock;
    }

    public string Greet(string name)
    {
        var o = _opt.CurrentValue; // æ”¯æ´è®Šæ›´å³æ™‚ç”Ÿæ•ˆ
        return $"{o.Message}, {name}! - from {o.From} at {_clock.Now():u}";
    }
}
```

**Startup.ConfigureServicesï¼ˆæ•´åˆè¨»å†Šï¼‰**

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddControllers();

    // Options ç¶å®š & ç›£è½è®Šæ›´
    services.Configure<GreetingOptions>(Configuration.GetSection("Greeting"));

    // DIï¼šè·¨ç« ç¯€æ²¿ç”¨çš„ IClock
    services.AddTransient<IClock, SystemClock>();

    // ä¸»è¦çš„æ‡‰ç”¨æœå‹™
    services.AddScoped<IGreetingService, GreetingService>();
}
```

**æ§åˆ¶å™¨ï¼ˆé©—è­‰æ‰€æœ‰æ‹¼è£ï¼‰**

```csharp
[ApiController, Route("api/greet")]
public class GreetingController : ControllerBase
{
    private readonly IGreetingService _svc;
    public GreetingController(IGreetingService svc) => _svc = svc;

    [HttpGet("{name}")]
    public IActionResult Get(string name)
    {
        var text = _svc.Greet(name);
        return Ok(new { text });
    }
}
```

**å‹•æ‰‹æ¸¬è©¦**

* ä¿®æ”¹ `appsettings.Development.json` çš„ `Greeting.Message` æˆ– `From`ï¼Œå„²å­˜å¾Œé‡æ•´ `GET /api/greet/Ada`ï¼Œä½ æœƒçœ‹åˆ°å›æ‡‰å³æ™‚åæ˜ è®Šæ›´ï¼ˆ`IOptionsMonitor`ï¼‰ã€‚

---

## 1.7 å°æŠ„èˆ‡æª¢æ ¸æ¸…å–®

âœ… **å°ˆæ¡ˆå•Ÿå‹•è·¯å¾‘**ï¼š`Program` å»ºä¸»æ©Ÿ â†’ `Startup.ConfigureServices` â†’ `Startup.Configure` â†’ Kestrel æ¥å®¢
âœ… **DI åŸå‰‡**ï¼šé è¨­é¸ Scopedï¼›è·¨è«‹æ±‚å…±äº«æ‰ç”¨ Singletonï¼ˆå‹™å¿…ç¢ºä¿åŸ·è¡Œç·’å®‰å…¨ï¼‰
âœ… **çµ„æ…‹å„ªå…ˆæ¬¡åº**ï¼š`appsettings` < `appsettings.{Env}` < User Secrets < ç’°å¢ƒè®Šæ•¸ < å‘½ä»¤åˆ—
âœ… **ç®¡ç·šé †åº**ï¼šRouting å‰çš„æ±è¥¿ï¼ˆä¾‹å¤–è™•ç†/éœæ…‹æª”ï¼‰â†’ `UseRouting` â†’ Auth â†’ `UseEndpoints`
âœ… **çŸ­è·¯è¡Œç‚º**ï¼š`Run` æœƒåœæ­¢å¾€ä¸‹å‚³éï¼›`Map/MapWhen` æœƒé–‹åˆ†æ”¯ï¼›`Use` å¯å‰å¾Œå¤¾æ“Š

---